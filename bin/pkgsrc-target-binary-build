#!/bin/sh

set -e

in_tmux_or_die() {
	: ${TMUX:?start a tmux first}
}

warn() {
	echo >&1 "$@"
}

package_rebuild() {
	sudo pkg_comp -c $HOME/trees/package-rebuild/etc/pkgcomp-conf auto
}

package_upload() {
	LATEST_PACKAGES=$(ls -t $HOME/binaries/packages | head -1)
	ADD_PACKAGES="$(cd $HOME/binaries/packages/${LATEST_PACKAGES}/All >/dev/null && for p in $(echo *.tgz); do if grep -q ^$(pkg_info -Q PKGPATH $p)\$ $HOME/trees/package-rebuild/etc/pkgcomp-autopackages; then echo $p; fi; done)"
	cat >/var/tmp/pkgsrc-target-binary-install <<EOT
#!/bin/sh

set -e

VINTAGE=$(echo ${LATEST_PACKAGES} | sed -e 's|^.*\([0-9]\{8\}-[0-9]\{6\}\)|\1|')
LATEST_PACKAGES=${LATEST_PACKAGES}
ADD_PACKAGES="${ADD_PACKAGES}"

run_as_root_if_not_already() {
	[ 0 -eq \$(id -u) ] || exec sudo "\$0"
}

pkg_add_everything() {
	pkg_add -K /opt/.pkg-\${VINTAGE}/libdata/pkgdb pkg_install*.tgz
	/opt/.pkg-\${VINTAGE}/sbin/download-vulnerability-list
	/opt/.pkg-\${VINTAGE}/sbin/pkg_add \${ADD_PACKAGES}
}

remove_new_trailing_lines_if_expected() {
	sed '\${/\/opt\/\.pkg-'\${VINTAGE}'\/bin\/bash/d;}' /etc/shells > /etc/shells.SCHMONZ && mv /etc/shells.SCHMONZ /etc/shells
}

services_to_stop() {
	echo "dovecot mysqld pound qmail redis rspamd djbdns"
}

services_to_start() {
	services_to_stop | perl -e '@r=reverse split / /,<>;chomp @r;print(join " ",@r);print "\n"'
}

stop_services() {
	for i in \$(services_to_stop); do
		/etc/rc.d/\$i stop
	done
}

bless_new_packages() {
	cd /opt
	rm pkg
	ln -s .pkg-\${VINTAGE} pkg
}

start_services() {
	for i in \$(services_to_start); do
		/etc/rc.d/\$i start
	done
}

post_upgrade_crap() {
	ikiwiki-mass-rebuild	# XXX doesn't work
	svc -t /home/*/service/*
}

remove_binary_packages() {
	rm -rf ~schmonz/packages/\${LATEST_PACKAGES}
}

remember_to_remove_sufficiently_old_installed_packages() {
	du -sh /opt/.pkg-*
	svstat /home/*/service/*
}

main() {
	run_as_root_if_not_already

	cd ~schmonz/packages/\${LATEST_PACKAGES}/All

	pkg_add_everything
	remove_new_trailing_lines_if_expected

	stop_services
	bless_new_packages
	start_services

	post_upgrade_crap
	remember_to_remove_sufficiently_old_installed_packages
	remove_binary_packages
}

main "\$@" 2>&1 | tee install.log
exit \$?
EOT
	LATEST_PACKAGES="binaries/packages/${LATEST_PACKAGES}"
	sudo cp /var/tmp/pkgsrc-target-binary-install ${LATEST_PACKAGES}

	sudo chmod +x ${LATEST_PACKAGES}/pkgsrc-target-binary-install
	sudo cp ~schmonz/build.log ${LATEST_PACKAGES}
	rsync -av --delete ${LATEST_PACKAGES} schmonz.com:packages/
	sudo rm -rf ${LATEST_PACKAGES}
}

package_run() {
	local _action _starttime
	_action="$1"
	_starttime=`date`
	package_${_action}

	warn
	warn "${_action} of schmonz.com packages complete"
	warn "Started:  ${_starttime}"
	warn "Finished: `date`"
	warn
}

main() {
	in_tmux_or_die

	package_run rebuild
	# XXX run a periodic rsync during the build, so this becomes short
	package_run upload
	echo "REMEMBER: run pkgsrc-free-disk-space and free-vm-space"
	### XXX sudo shutdown -hp now
}

main "$@" 2>&1 | tee build.log
exit $?
