#!/bin/sh

MAC_TREES="buildbox@10.0.2.2:/Users/buildbox/Documents/trees"
VM_TREES="$HOME/trees"

PKGSRCDIR="pkgsrc-current"
NOTQMAILDIR="notqmail"
IKIWIKIDIR="ikiwiki"

_mount_puffs() {
	local _telltale _from _to
	_telltale="${VM_TREES}/$3/$1"
	_from="${MAC_TREES}/$2"
	_to="${VM_TREES}/$3"
	[ -f "${_telltale}" ] && return 0
	[ -d "${_to}" ] || mkdir -p "${_to}"

        sudo env SSH_AUTH_SOCK=$SSH_AUTH_SOCK mount_psshfs \
		-u 502 \
		-g 20 \
		"${_from}" "${_to}"
}

_mount_sshfs() {
	local _telltale _from _to
	_telltale="${VM_TREES}/$3/$1"
	_from="${MAC_TREES}/$2"
	_to="${VM_TREES}/$3"
	[ -f "${_telltale}" ] && return 0
	[ -d "${_to}" ] || mkdir -p "${_to}"

        sudo env SSH_AUTH_SOCK=$SSH_AUTH_SOCK sshfs \
                -o idmap=file \
                -o allow_other \
                -o uidfile=$HOME/etc/sshfs-uids \
                -o gidfile=$HOME/etc/sshfs-gids \
		"${_from}" "${_to}"
}

_mount_all() {
	local _mount_command
	_mount_command="_mount_${1}"
	${_mount_command} mk/defaults/mk.conf "$PKGSRCDIR" "$PKGSRCDIR"
	${_mount_command} conf-qmail "$NOTQMAILDIR" "$NOTQMAILDIR"
	${_mount_command} ikiwiki.spec "$IKIWIKIDIR" "$IKIWIKIDIR"
}


main() {
	case "$(uname)" in
	NetBSD)
		_mount_all puffs
		;;
	FreeBSD|Linux|OpenBSD)
		_mount_all sshfs
		;;
	*)
		echo >&2 "unknown OS"
		exit 1
		;;
	esac
}

main "$@"
exit $?
