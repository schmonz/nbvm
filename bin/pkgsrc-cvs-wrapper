#!/bin/sh
#
# vim: set ts=2:sw=2

set -e

absolute_parent_of_current_script() {
	show_physical_path "$(dirname "$0" | sed -e "s|^\./|$(pwd)/|")"
}

remove_ourselves_from_path() {
	PATH="$(remove_dir_from_path "${PATH}" $(absolute_parent_of_current_script))"
}

remove_dir_from_path() {
	local path dir
	path="$1"; shift
	dir="$1"; shift
	echo "${path}" \
		| tr ':' '\n' \
		| grep -v "^${dir}\$" \
		| tr '\n' ':' \
		| sed -e 's|:$||'
}

show_physical_path() {
	local path
	path="$1"; shift
	if ( command -v readlink >/dev/null 2>&1 ); then
		readlink -f "${path}"
	elif ( command -v realpath >/dev/null 2>&1 ); then
		realpath "${path}"
	else
		echo >&2 "don't know how to canonicalize physical path"
		exit 5
	fi
}

run_adjusted_command_line() {
	if [ "$#" -gt 0 ]; then
		case "$1" in
			diff)
				exec cvs "$@" | colordiff | less -F
				;;
			show)
				shift
				exec cvsps -g -s "$@" | colordiff | less -F
				;;
			tig)
				shift
				exec cvsps -x "$@" | less -F
				;;
			*)
				exec cvs "$@"
				;;
		esac
	else
		exec cvs "$@"
	fi
}

main() {
	remove_ourselves_from_path
	run_adjusted_command_line "$@"
}

main "$@"
exit $?
