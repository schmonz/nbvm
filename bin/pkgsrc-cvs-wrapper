#!/bin/sh
#
# vim: set ts=2:sw=2

set -e

absolute_parent_of_current_script() {
	show_physical_path "$(dirname "$0" | sed -e "s|^\./|$(pwd)/|")"
}

remove_ourselves_from_path() {
	PATH="$(remove_dir_from_path "${PATH}" $(absolute_parent_of_current_script))"
}

remove_dir_from_path() {
	local path dir
	path="$1"; shift
	dir="$1"; shift
	echo "${path}" \
		| tr ':' '\n' \
		| grep -v "^${dir}\$" \
		| tr '\n' ':' \
		| sed -e 's|:$||'
}

show_physical_path() {
	local path
	path="$1"; shift
	realpath "${path}"
}

run_adjusted_command_line() {
	if [ "$#" -gt 0 ]; then
		case "$1" in
			diff)
				exec cvs "$@" | colordiff | less -F
				;;
			show)
				shift
				exec cvsps -g -s "$@" | colordiff | less -F
				;;
			tig)
				shift
				exec cvsps -x "$@" | less -F
				;;
		esac
	else
		exec cvs "$@" | less -F
	fi
}

main() {
	remove_ourselves_from_path
	run_adjusted_command_line "$@"
}

main "$@"
exit $?
