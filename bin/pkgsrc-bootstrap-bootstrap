#!/bin/sh

set -e

TREESDIR=~/trees

warn() {
	echo >&2 "$@"
}

main() {
	_sysconfdir="/etc/pkg"
	cd ${TREESDIR}/pkgsrc-cvs/bootstrap
	./bootstrap \
		--mk-fragment ${TREESDIR}/package-rebuild/etc/buildvm-bootstrap-mk-fragment \
		--workdir /var/tmp/pkgsrc-bootstrap \
		--varbase /var/pkg \
		--sysconfdir "${_sysconfdir}" \
		--sysconfbase /etc \
		--prefix /opt/pkg \
		--prefer-pkgsrc yes \
		"$@"
	ln -s ${TREESDIR}/package-rebuild/etc/buildvm-mk.shared.conf "${_sysconfdir}"
	warn "SCHMONZ  1: cull ${_sysconfdir}/mk.conf: keep ABI, PKGSRC_COMPILER, TOOLS_PLATFORM.foo"
	warn "SCHMONZ  2: drop to regular user"
	warn "SCHMONZ  3: cd ${TREESDIR}/dotfiles && /opt/pkg/bin/bmake dotfiles"
	warn "SCHMONZ  4: mkdir -p ~/.vim && ln -s ${TREESDIR}/vimbundle ~/.vim/bundle"
	warn "SCHMONZ  5: . ~/.profile"
	warn "SCHMONZ  6: bmake; man bmake"
	warn "SCHMONZ  7: cd ${TREESDIR}/package-rebuild/bin && bmake pkgsrc"
	warn "SCHMONZ  8: cd ${TREESDIR}/pkgsrc-cvs/pkgtools/shlock && msv BUILDVM_PLATFORM"
	warn "SCHMONZ  9: make install clean"
	warn "SCHMONZ ??: cd ../../security/sudo && make install clean"
	warn "SCHMONZ 11: sudo pkg_admin fetch-pkg-vulnerabilities"
	warn "SCHMONZ ??: cd ../../lang/gcc10 && make install clean"
	warn "SCHMONZ 13: cd ../../shells/bash && make install clean"
	warn "SCHMONZ 14: chsh"
	warn "SCHMONZ 15: cd ../../pkgtools/pkg_rolling-replace && make install clean"
	warn "SCHMONZ 16: cd ../../net/fetch && make install clean"
	warn "SCHMONZ 17: pkgsrc-bootstrap-rebuild-uncompressed-manpages"
	warn "SCHMONZ ??: cd ../../sysutils/etckeeper && make install clean"
	warn "SCHMONZ ??: sudo etckeeper init && sudo etckeeper commit -m 'Initial commit.'"
	warn "SCHMONZ ??: ( cd ${_sysconfdir} && sudo git branch -M PLATFORM && sudo git gc && sudo git push -u origin HEAD )"
	warn "SCHMONZ 21: cd ../../meta-pkgs/pkg_developer && make install clean"
	warn "SCHMONZ 22: pkgsrc-bootstrap-moretools"
	warn "SCHMONZ 23: cd ../../meta-pkgs/qmail-server && make install clean"
	warn "SCHMONZ 24: cd ../../www/ikiwiki && make install clean"
	warn "SCHMONZ 25: cd ../../pkgtools/pkg_comp && make install clean"
}

main "$@"
exit $?
